#!/usr/bin/env sh

set -e

info () {
  printf "INFO [go-exploitdb-update]: %s\n" "${1}"
}

error () {
  printf "ERROR [go-exploitdb-update]: %s\n" "${1}"
}

update () {
  local config
  config=/etc/go-exploitdb/go-exploitdb.yaml

  for db in awesomepoc exploitdb githubrepos inthewild; do
    info "updating database: ${db}"
    go-exploitdb --config="${config}" fetch "${db}" || error "failed to update database: ${db}"
  done
}

main () {
  (
    flock -n 200 || error "failed to acquire lock."
    update
  ) 200>/var/lock/go-exploitdb-update.lock
}

main
